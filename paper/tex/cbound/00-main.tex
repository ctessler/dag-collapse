\section{Collapsing of Nodes}
\newcommand{\tex}[1]{cbound/#1}

\label{sec:collapse-bound}

For a task ${\tau_i \in \tau}$, associated DAG
${G_i \in \mathbb{G}}$, where ${G_i = (V, E)}$, with nodes
${u,v \in V}$ that qualify as candidates for collapse, collapsing
${u}$ and ${v}$ may (or may not) result an increase in
performance. This section provides a method of determining if the
collapse of ${u}$ and ${v}$ will \emph{benefit} the performance of the 
task set ${\tau}$ in terms of ${m_i}$: the number of cores
dedicated to ${\tau_i}$.

For a task ${\tau_i}$ with ${m_i}$ dedicated cores, collapsing
${u}$ and ${v}$ benefits ${\tau_i}$ (and therefor ${\tau}$) if the
number of cores dedicated to ${\tau_i}$ is potentially reduced. If
${m_i}$ is the number of cores dedicated to ${\tau_i}$ before
collapsing ${u}$ and ${v}$, and ${\hat{m_i}}$ the number of
cores after collapse, beneficial collapse is defined as follows: 

\begin{definition}[Beneficial Collapse]
  Collapsing ${u}$ and ${v}$ is \emph{beneficial} if and only if
  ${\hat{m_i} \le m_i}$.
\end{definition}

The number of cores dedicated to task ${\tau_i}$ is determined by
Equation~\ref{eq:m} which is replicated below. Equation~\ref{eq:m}
depends on the critical path length ${L_i}$ and workload
${C_i}$, both of which can be affected by collapsing nodes.

\begin{multicols}{2}
  \begin{equation*}
    m_i = \left\lceil
      \frac{C_i - L_i}
           {D_i - L_i}
    \right\rceil
  \end{equation*}
  \begin{equation*}
    C_i = \sum_{v \in V} c_v(\eta_v)
  \end{equation*}
\end{multicols}

For simplicity of presentation, it is assumed the entire object each
thread assigned to ${v}$ executes fits entirely within the
cache of each core. Additionally, each core is required to be
timing-compositional~\addcite{}, where the memory and execution demand
are separable. The memory demand of populating the cache with the
entire object ${\alpha_v}$ associated with ${v}$ is referred to as
${\mathbb{B}_v}$. Execution demand of one thread over ${\alpha_v}$ is
referred to as ${\mathbb{I}_v}$. 

Applying the principle of inter-thread cache benefit from \addcite{}
[BUNDLE and BUNDLEP], the WCET of a node ${v}$ is given by:

\begin{equation}
  c_v(\eta_v) = \mathbb{B}_v + \eta_v \cdot \mathbb{I}_v
\end{equation}

When comparing parameters before and after collapse, the after
collapse values will be give a ``hat'' indicator. For example, the
critical path length before collapse is denoted
${L_i}$; after collapse it is denoted ${\hat{L_i}}$.

When two nodes ${u,v \in V}$ are collapsed into ${\hat{u}}$, the WCET
of ${\hat{u}}$ can be described in terms of the WCET of ${u}$ and
${v}$. Under the assumption that ${\alpha_u}$ fits entirely in the
cache, combined with the timing-compositional 
requirement of each core, scheduling ${\eta_u}$ followed by ${\eta_v}$
threads on the same core places all values in the cache before they
are executed. Therefor, the memory demand of ${\eta_u + \eta_v}$
threads is ${\mathbb{B}_u}$. The separable execution demand of
${\eta_u}$ followed by ${\eta_v}$ threads is ${(\eta_u + \eta_v) \cdot
  \mathbb{I}_u}$ because ${\mathbb{I}_u = \mathbb{I}_v}$. Thus, the
WCET of ${\hat{c}_u(u)}$ can be defined as  
follows:
\begin{equation*}
  \hat{c}_u(u) = c_u(u + v) = \mathbb{B}_u + (\eta_u + \eta_v) \cdot
      \mathbb{I}_u 
\end{equation*}

\begin{theorem}[Conditional Collapse] \label{thm:collapse}
  For a task ${\tau_i \in \tau}$, associated DAG ${G_i \in \mathbb{G}}$,
  where ${G_i = (V, E)}$, candidate nodes ${u,v \in V}$,
  collapsing ${u}$ and ${v}$ into ${\hat{u}}$ is beneficial if:

  \begin{equation}
    \indent
    1 + \frac{\mathbb{B}_u}{\eta_v \cdot \mathbb{I}_u}
    \ge
    \frac{C_i - L_i}
         {D_i - L_i}
    \label{eq:condition}
  \end{equation}

  \begin{proof}
    The goal of the proof is to show the comparison of
    Equation~\ref{eq:collapse-condition} is true
    under all circumstances. There are four cases which cover all
    possible changes to the critical path length and workload of the
    task ${\tau_i}$. Note, the deadline of the task ${D_i}$ cannot
    be changed and does not need consideration. 

    \begin{equation} \label{eq:collapse-condition}
      \indent
      \frac{\hat{C_i} - \hat{L_i}}
           {D_i - \hat{L_i}} \le
      \frac{C_i - L_i}
           {D_i - L_i}
    \end{equation}

    In summary, the four cases to consider are:

    \begin{enumerate}
    \item ${(u, v \not \in \lambda_i)
      \land
      (\hat{u} \not \in \hat{\lambda_i})}$:
      Neither node is on the critical path before collapse and
      ${\hat{u}}$ is not on the critical path after collapse. 
    \item ${(u \in \lambda_i \land v \not \in \lambda_i)
      \land
      (\hat{u} \in \hat{\lambda_i})}$: One node (call it ${u}$)
      is on the critical path before collapse and remains on the path
      after collapse.
    \item ${(u,v \in \lambda_i) \land
      (\hat{u} \in \hat{\lambda_i})}$: Both nodes lie
      on the critical path before collapse.
    \item ${(u,v \not \in \lambda_i) \land
      (\hat{u} \in \hat{\lambda_i})}$: Neither node
      belongs to the critical path before collapse. Collapsing the
      nodes creates a \textbf{new} critical path.
    \end{enumerate}

    \begin{case}[${(u, v \not \in \lambda_i) \land
          (\hat{u} \not \in \hat{\lambda_i})}$] By
      definition of critical path and critical path length, ${u}$ and
      ${v}$ do not contribute to ${L_i}$ nor ${\hat{u}}$ to
      ${\hat{L_i}}$. Therefor, ${L_i = \hat{L_i}}$. The
      workload has been affected by the removal of ${v}$ and ${u}$'s
      execution  and the increase in ${\hat{u}}$'s execution. 
      \begin{align}
        \indent
        \hat{C}_i &= C_i - c_u(\eta_u) - c_v(\eta_v) +
        \hat{c}_u(\eta_u + \eta_v) \\
        &= C_i - \mathbb{B}_u - \eta_u \cdot \mathbb{I}_u
            - \mathbb{B}_v - \eta_v \cdot \mathbb{I}_v +
            \hat{c}_u(\eta_u + \eta_v)
            \label{eq:pre-u} \\
        &= C_i - \mathbb{B}_u - \eta_u \cdot \mathbb{I}_u
            - \mathbb{B}_u - \eta_v \cdot \mathbb{I}_u +
            \hat{c}_u(\eta_u + \eta_v)
            \label{eq:post-u} \\
        &= C_i -2\mathbb{B}_u - (\eta_u + \eta_v)\cdot \mathbb{I}_u +
            \hat{c}_u(\eta_u + \eta_v) \\
        &= C_i -2\mathbb{B}_u - (\eta_u + \eta_v)\cdot \mathbb{I}_u +
            \mathbb{B}_u + (\eta_u + \eta_v)\cdot \mathbb{I}_u \\
        &= C_i - \mathbb{B}_u
      \end{align}

      From Equation~\ref{eq:pre-u} to Equation~\ref{eq:post-u}, the
      subscripts on the memory and execution demand of ${v}$ are
      substituted with ${u}$. This is permissible because ${u}$ and
      ${v}$ refer to the same object (${\alpha_u = \alpha_v}$).

      It must be the case that ${\mathbb{B}_u \ge 0}$, therefore
      ${\hat{C}_i \le C_i}$, the condition of
      Equation~\ref{eq:collapse-condition} is true.
    \end{case}

    \begin{case}[${(u \in \lambda_i \land v \not \in \lambda_i)
      \land (\hat{u} \in \hat{\lambda_i})}$] When ${v}$ is
      collapsed into ${u}$ and ${\hat{u}}$ lies on the critical path
      ${\hat{\lambda_i}}$, the length of the critical path
      ${\hat{L_i}}$ must have been affected (since the
      execution of ${\eta_v}$ threads are now included in
      ${\hat{L_i}}$). Thus the difference in the ${L_i}$ is:
      \begin{align*}
        \indent
        \hat{L_i} &= L_i - c_u(\eta_u) + c_u(\eta_u + \eta_v) \\
        &= L_i - (\mathbb{B}_u + \eta_u \cdot \mathbb{I}) +
            \mathbb{B}_u + (\eta_u + \eta_v) \cdot \mathbb{I}_u \\
        &= L_i + \eta_v \cdot \mathbb{I}_u
      \end{align*}


      Case 1 established the change in workload
      ${\hat{C_i}}$ as ${\mathbb{B}_u}$. The goal for this
      case is to find a restriction under which
      Equation~\ref{eq:collapse-condition} is true given the
      differences in workload and critical path length. To do so, the
      condition is assumed to be true in order to deduce the restriction.

      \begin{align*}
        \indent
        \frac{\hat{C_i} - \hat{L_i}} 
             {D_i - \hat{L_i}} &\le
        \frac{C_i - L_i}
             {D_i - L_i} \\
        \frac{C_i - \mathbb{B}_u - (L_i + \eta_v
          \cdot \mathbb{I}_u)} 
             {D_i - (L_i + \eta_v
          \cdot \mathbb{I}_u)} &\le
        \frac{C_i - L_i}
             {D_i - L_i} \\
        (D_i - L_i)(C_i - \mathbb{B}_u - (L_i + \eta_v \cdot \mathbb{I}_u))
             &\le
             (C_i - L_i)(D_i - (L_i + \eta_v \cdot \mathbb{I}_u)) \\
        (D_i - L_i)((C_i - L_i) - (\mathbb{B}_u + \eta_v \cdot \mathbb{I}_u))
             &\le
             (C_i - L_i)((D_i - L_i) - \eta_v \cdot \mathbb{I}_u)) \\
        (D_i - L_i)(C_i - L_i) -
             (D_i - L_i)(\mathbb{B}_u + \eta_v \cdot \mathbb{I}_u)
             &\le
             (C_i - L_i)(D_i - L_i) - (C_i - L_i)(\eta_v \cdot \mathbb{I}_u) \\
        (D_i - L_i)(\mathbb{B}_u + \eta_v \cdot \mathbb{I}_u)
             &\ge
             (C_i - L_i)(\eta_v \cdot \mathbb{I}_u) \\
        \frac{\mathbb{B}_u + \eta_v \cdot \mathbb{I}_u}
             {\eta_v \cdot \mathbb{I}_u}
             &\ge
             \frac{C_i - L_i}{D_i - L_i} \\
        1 + \frac{\mathbb{B}_u}
             {\eta_v \cdot \mathbb{I}_u}
             &\ge
             \frac{C_i - L_i}{D_i - L_i}
      \end{align*}

      The inequality follows directly from the condition of
      Equation~\ref{eq:collapse-condition}.
    \end{case}

    \begin{case}[${(u,v \in \lambda_i) \land
          (\hat{u} \in \hat{\lambda_i})}$]
      When both nodes lie on the critical path before collapse,
      ${\hat{L}_i}$ is affected in the same manner as ${\hat{C}_i}$ in
      Case 1. 

      \begin{align*}
        \indent
        \hat{L}_i &= L_i - c_u(\eta_u) - c_v(\eta_v) + c(\eta_u +
            \eta_v) \\
        &= L_i - \mathbb{B}_u
      \end{align*}

      Using the workload difference from Case 1 and substituting into
      Equation~\ref{eq:collapse-condition}:

      \begin{align*}
        \indent
        \frac{\hat{C_i} - \hat{L_i}} 
             {D_i - \hat{L_i}} &\le
        \frac{C_i - L_i} 
             {D_i - L_i} \\
        \frac{C_i - \mathbb{B}_u - (L_i - \mathbb{B}_u)}
             {D_i - (L_i - \mathbb{B}_u)}
             &\le
        \frac{C_i - L_i} 
             {D_i - L_i} \\
        \frac{C_i - L_i}
             {D_i - L_i + \mathbb{B}_u}
             &\le
        \frac{C_i - L_i} 
             {D_i - L_i}
      \end{align*}

      Since ${\mathbb{B}_u \ge 0}$, the inequality must be true.
    \end{case}

    
    \begin{case}[${(u,v \not \in \lambda_i) \land
          (\hat{u} \in \hat{\lambda_i})}$]
      When neither node participated in the critical path before
      collapse and when collapsed create a new critical path
      ${\lambda_i \not = \hat{\lambda_i}}$, ${\hat{u}}$
      must lie on the new critical path
      ${\hat{u} \in \hat{\lambda_i}}$. Consequently, the
      new critical path length must be greater than or equal to the
      previous value ${\hat{L}_i \ge L_i}$. The difference in length
      is bounded by the increase in execution:

      \begin{align*}
        \hat{L}_i - L_i &\le c_u(\eta_u + \eta_v) - c_u(\eta_u) \\
        &\le \mathbb{B}_u + (\eta_u + \eta_v) \cdot \mathbb{I}_u
            - (\mathbb{B}_u + \eta_u \cdot \mathbb{I}_u) \\
        &\le \eta_v \cdot \mathbb{I}_u \\
        \hat{L}_i & \le L_i + \eta_v \cdot \mathbb{I}_u
      \end{align*}

      Substituting the inequality of
      ${\hat{L}_i \le L_i + \eta_v \cdot \mathbb{I}_u}$ derived here in
      Case 4, into Case 2 reaches the same conclusion. If
      Equation~\ref{eq:condition} is satisfied then
      Equation~\ref{eq:collapse-condition} is true.
    \end{case}

    
    Cases 1-4 encompass all conditions under which candidates for
    collapse may impact the number of cores assigned to ${\tau_i}$. In
    each circumstance the condition of Equation
    ~\ref{eq:collapse-condition} is true. Thus, for candidate nodes
    obeying the restriction described by Equation~\ref{eq:condition}
    it is beneficial to collapse them.
  \end{proof}
\end{theorem}

\input{\tex{10-relaxing.tex}}
